<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stylelint Improvements Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        .file-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .file-item {
            padding: 5px;
            margin: 2px 0;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }
        .valid-file { background-color: #d4edda; }
        .invalid-file { background-color: #f8d7da; }
        .unknown-file { background-color: #fff3cd; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 14px;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>Stylelint Improvements Test</h1>
    
    <div class="test-section">
        <h2>1. File Validation Test</h2>
        <div id="fileValidationResult"></div>
        
        <h3>Valid CSS/SCSS Files</h3>
        <div id="validFiles" class="file-list"></div>
        
        <h3>Invalid/Unknown Files</h3>
        <div id="invalidFiles" class="file-list"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Stylelint Report Analysis</h2>
        <div id="reportAnalysisResult"></div>
        
        <div id="reportStats" class="stats"></div>
        
        <h3>Report Details</h3>
        <div id="reportDetails"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Error Handling Test</h2>
        <div id="errorHandlingResult"></div>
        <button onclick="testErrorHandling()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Test Error Handling
        </button>
    </div>

    <script>
        // Test data for validation
        const testFiles = [
            // Valid files
            'src/styles/main.css',
            'src/components/button.scss',
            'src/layout/header.sass',
            'src/themes/dark.less',
            'assets/css/style.css',
            'styles/components/_button.scss',
            
            // Invalid files that should be skipped
            'src/styles/main.js',
            'src/components/button.tsx',
            'src/layout/header.html',
            'src/themes/dark.json',
            'assets/css/style.min.css',
            'styles/components/_button.map',
            'node_modules/bootstrap/dist/bootstrap.css',
            'dist/assets/style.bundle.css',
            'build/css/style.css',
            'coverage/lcov-report/style.css',
            'report/stylelint-report.json',
            '.git/objects/style.css',
            'vendor/bootstrap/style.css',
            
            // Non-existent files
            'src/styles/nonexistent.css',
            'src/components/missing.scss',
            
            // Directory paths
            'src/styles/',
            'src/components/',
            
            // Files with special characters
            'src/styles/main (copy).css',
            'src/components/button-v2.scss',
            'src/layout/header (1).sass'
        ];

        // Simulate file validation logic
        function validateFile(filePath) {
            const ext = filePath.split('.').pop().toLowerCase();
            const validExtensions = ['css', 'scss', 'sass', 'less'];
            
            // Check if it's a valid CSS file
            if (!validExtensions.includes(ext)) {
                return { valid: false, reason: 'Invalid file extension' };
            }
            
            // Check if it should be excluded
            const excludePatterns = [
                'node_modules',
                'dist',
                'build',
                'coverage',
                'report',
                'reports',
                '.git',
                'vendor',
                'bower_components',
                '.min.css',
                '.bundle.css',
                '.map'
            ];
            
            for (const pattern of excludePatterns) {
                if (filePath.includes(pattern)) {
                    return { valid: false, reason: `Excluded by pattern: ${pattern}` };
                }
            }
            
            // Check if it's a directory
            if (filePath.endsWith('/')) {
                return { valid: false, reason: 'Is a directory' };
            }
            
            return { valid: true, reason: 'Valid CSS file' };
        }

        // Test file validation
        function testFileValidation() {
            const validFiles = [];
            const invalidFiles = [];
            
            testFiles.forEach(filePath => {
                const validation = validateFile(filePath);
                if (validation.valid) {
                    validFiles.push({ path: filePath, reason: validation.reason });
                } else {
                    invalidFiles.push({ path: filePath, reason: validation.reason });
                }
            });
            
            // Display results
            const validContainer = document.getElementById('validFiles');
            const invalidContainer = document.getElementById('invalidFiles');
            
            validContainer.innerHTML = validFiles.map(file => 
                `<div class="file-item valid-file">✓ ${file.path} (${file.reason})</div>`
            ).join('');
            
            invalidContainer.innerHTML = invalidFiles.map(file => 
                `<div class="file-item invalid-file">✗ ${file.path} (${file.reason})</div>`
            ).join('');
            
            // Update stats
            document.getElementById('fileValidationResult').innerHTML = `
                <div class="test-result success">
                    ✓ File validation test completed<br>
                    ✓ Found ${validFiles.length} valid files<br>
                    ✓ Excluded ${invalidFiles.length} invalid files<br>
                    ✓ No "Unknown" files should appear in reports
                </div>
            `;
            
            return { validFiles, invalidFiles };
        }

        // Test report analysis
        async function testReportAnalysis() {
            const resultDiv = document.getElementById('reportAnalysisResult');
            resultDiv.innerHTML = '<div class="test-result info">Analyzing Stylelint report...</div>';
            
            try {
                const response = await fetch('./stylelint-report.json');
                if (response.ok) {
                    const report = await response.json();
                    
                    // Analyze report
                    const results = report.results || [];
                    const totalFiles = results.length;
                    const filesWithErrors = results.filter(r => r.errorCount > 0).length;
                    const totalErrors = results.reduce((sum, r) => sum + r.errorCount, 0);
                    const unknownFiles = results.filter(r => r.filePath === 'Unknown' || r.filePath.includes('Unknown')).length;
                    
                    // Display stats
                    const statsContainer = document.getElementById('reportStats');
                    statsContainer.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-number">${totalFiles}</div>
                            <div class="stat-label">Total Files</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${filesWithErrors}</div>
                            <div class="stat-label">Files with Errors</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${totalErrors}</div>
                            <div class="stat-label">Total Errors</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${unknownFiles}</div>
                            <div class="stat-label">Unknown Files</div>
                        </div>
                    `;
                    
                    // Display report details
                    const detailsContainer = document.getElementById('reportDetails');
                    if (results.length > 0) {
                        detailsContainer.innerHTML = `
                            <h4>Files in Report:</h4>
                            <div class="file-list">
                                ${results.map(result => `
                                    <div class="file-item ${result.filePath.includes('Unknown') ? 'unknown-file' : 'valid-file'}">
                                        ${result.filePath} (${result.errorCount} errors)
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        detailsContainer.innerHTML = '<div class="test-result warning">No files found in report</div>';
                    }
                    
                    // Show results
                    const status = unknownFiles === 0 ? 'success' : 'error';
                    const message = unknownFiles === 0 ? 
                        '✓ No unknown files found in report' : 
                        `✗ Found ${unknownFiles} unknown files in report`;
                    
                    resultDiv.innerHTML = `
                        <div class="test-result ${status}">
                            ${message}<br>
                            ✓ Report contains ${totalFiles} files<br>
                            ✓ ${filesWithErrors} files have errors<br>
                            ✓ Total of ${totalErrors} errors found
                        </div>
                    `;
                    
                } else {
                    resultDiv.innerHTML = `
                        <div class="test-result error">
                            ✗ Could not load stylelint-report.json (HTTP ${response.status})<br>
                            Make sure to run the Stylelint audit first
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="test-result error">
                        ✗ Error analyzing report: ${error.message}<br>
                        Make sure stylelint-report.json exists in the current directory
                    </div>
                `;
            }
        }

        // Test error handling
        function testErrorHandling() {
            const resultDiv = document.getElementById('errorHandlingResult');
            resultDiv.innerHTML = '<div class="test-result info">Testing error handling...</div>';
            
            // Simulate different error scenarios
            const errorScenarios = [
                { file: 'nonexistent.css', error: 'ENOENT', description: 'File not found' },
                { file: 'permission-denied.css', error: 'EACCES', description: 'Permission denied' },
                { file: 'is-directory/', error: 'EISDIR', description: 'Path is directory' },
                { file: 'invalid-file.txt', error: 'INVALID_EXT', description: 'Invalid file extension' }
            ];
            
            let handledErrors = 0;
            errorScenarios.forEach(scenario => {
                // Simulate error handling
                if (scenario.error === 'ENOENT') {
                    console.log(`[Stylelint] File not found: ${scenario.file}`);
                    handledErrors++;
                } else if (scenario.error === 'EACCES') {
                    console.log(`[Stylelint] Permission denied: ${scenario.file}`);
                    handledErrors++;
                } else if (scenario.error === 'EISDIR') {
                    console.log(`[Stylelint] Path is directory, not file: ${scenario.file}`);
                    handledErrors++;
                } else if (scenario.error === 'INVALID_EXT') {
                    console.log(`[Stylelint] Skipping non-CSS file: ${scenario.file}`);
                    handledErrors++;
                }
            });
            
            resultDiv.innerHTML = `
                <div class="test-result success">
                    ✓ Error handling test completed<br>
                    ✓ ${handledErrors}/${errorScenarios.length} error scenarios handled correctly<br>
                    ✓ Invalid files are properly excluded from processing<br>
                    ✓ No null results should appear in final report
                </div>
            `;
        }

        // Initialize tests
        window.addEventListener('load', () => {
            // Test file validation
            testFileValidation();
            
            // Test report analysis
            testReportAnalysis();
        });
    </script>
</body>
</html> 